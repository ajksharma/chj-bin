#!/bin/bash

set -eu

usage() {
    echo "$0 [-z] files_to_offer"
    echo "  offer files, encrypted"
    exit 1
}

if [ $# -lt 1 -o "$1" = "-h" -o "$1" = "--help" ]; then
    usage
fi

z=""
if [ "$1" = "-z" ]; then
    z="-z "; shift
elif [ "$1" = "--" ]; then
    shift
fi

if [ ! "${PORT-}" ]; then
    PORT=$((14123+$UID))
fi

ip=`publicip -f`
pwfile=`tempfile`

passwdgen 20 >"$pwfile"

echo "--Run:--"
echo "echo `cat "$pwfile"` | netfetch $z$ip $PORT"

tar c ${z}-f - "$@" \
    | gpg -z0 -c --batch --force-mdc --passphrase-file "$pwfile" \
    | netcat -q 1 -l -p "$PORT" 

rm "$pwfile"
