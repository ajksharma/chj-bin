#!/usr/bin/perl -w

# Fre Aug  6 01:30:02 MEST 2004
(my $email='XXX%YYY,ch')=~ tr/%,/@./;

use strict;

$0=~ /(.*?)([^\/]+)\z/s or die "?"; 
my ($mydir, $myname)=($1,$2); 
sub usage {
    print STDERR map{"$_\n"} @_ if @_;
    print "$myname [file(s)]
  or stdin.
  Options:
  -h headername   print header value(s?)
  --last-header headername
                  print the header appearing last in the head text
                  (but might be the one having been added to the head
                  as the first in time)

  (Christian Jaeger <$email>)
";
exit @_ ? 1 : 0;
}

use Getopt::Long;
our $verbose=0;
our ($opt_h,$opt_last_header);
GetOptions("verbose"=> \$verbose,
	   "help"=> sub{usage},
	   "h|headers=s" => \$opt_h,
	   "last-header=s" => \$opt_last_header,
	   ) or exit 1;
usage unless @ARGV;


use MIME::Parser;
use Chj::xopen 'xopen_read';
use Chj::singlequote;

my $parser = new MIME::Parser;
$parser->output_under("/tmp");# IMPORTANT! or it will put them to cwd. -- wondering: IS THIS really SAFE?

sub parsemsg {
    my ($fh)=@_;
    my $ent= $parser->parse($fh);
    #use Data::Dumper;
    #print Dumper $ent;
    $ent
}

usage "don't give both -h and --last-header" if $opt_h && $opt_last_header;
my $search_header= $opt_h || $opt_last_header;

if (@ARGV) {
    for (@ARGV) {
	print "File ".singlequote($_).":\n" if $verbose;
	my $f=xopen_read $_;
	my $ent=parsemsg($f);

	if ($search_header) { #show header
	    my $show= sub {
		my ($prefix,$maybe_value)=@_;
		if ($verbose) {
		    print $prefix." ".singlequote($search_header)
		      .(defined ($maybe_value) ? ": ".singlequote($maybe_value) : "")
			."\n";
		} else {
		    if (defined $maybe_value) {
			print $maybe_value;
		    }
		}
	    };

	    my $head=$ent->head;
	    my @vals= $head->get($search_header);
	    if (@vals==0) {
		&$show("no such header");
	    } else {
		if ($opt_last_header) {
		    print $vals[-1];
		} else {
		    if(@vals==1){
			&$show("one such header",$vals[0]);
		    } else {
			my $i=0;
			for(@vals){
			    &$show("$i. header", $_);
			    $i++;
			}
		    }
		}
	    }
	} else {
	    die "unknown command requested <--- unfinished";
	}
    }
}
else {
    parsemsg(*STDIN{IO});
}
